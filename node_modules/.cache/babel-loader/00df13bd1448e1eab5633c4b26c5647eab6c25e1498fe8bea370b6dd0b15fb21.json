{"ast":null,"code":"import React,{useState,useRef,useLayoutEffect}from\"react\";import*as pdfjs from\"pdfjs-dist\";// Import for PDF.js\nimport{useSession}from\"./SessionContext\";// Import for session context\n// Fabric.js (CommonJS import)\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const fabric=require(\"fabric\").fabric;// Set the worker source for PDF.js\npdfjs.GlobalWorkerOptions.workerSrc=\"/pdf.worker.mjs\";// Ensure this is correctly set up\nconst DocumentCanvas=()=>{const{sessionId,documentUrl}=useSession();// Access sessionId and documentUrl from the session context\nconst canvasRef=useRef(null);const socket=useRef(null);const[currentPage,setCurrentPage]=useState(1);const[totalPages,setTotalPages]=useState(0);useLayoutEffect(()=>{if(!canvasRef.current){console.warn(\"Canvas reference is not ready yet.\");return;}if(!sessionId){console.error(\"Session ID is missing. WebSocket connection cannot be established.\");return;}let canvasInstance;// Initialize Fabric.js canvas\ntry{canvasInstance=new fabric.Canvas(canvasRef.current,{width:800,height:600});console.log(\"Fabric.js canvas initialized.\");}catch(error){console.error(\"Error initializing Fabric.js canvas:\",error);return;}const renderPDFToCanvas=async pageNumber=>{if(!documentUrl){console.warn(\"No document URL provided.\");return;}try{const pdf=await pdfjs.getDocument(documentUrl).promise;setTotalPages(pdf.numPages);const page=await pdf.getPage(pageNumber);const viewport=page.getViewport({scale:1.5});const pdfCanvas=document.createElement(\"canvas\");pdfCanvas.width=viewport.width;pdfCanvas.height=viewport.height;const context=pdfCanvas.getContext(\"2d\");await page.render({canvasContext:context,viewport}).promise;// Set PDF page as the background for the Fabric.js canvas\nfabric.Image.fromURL(pdfCanvas.toDataURL(),oImg=>{canvasInstance.setBackgroundImage(oImg,canvasInstance.renderAll.bind(canvasInstance));console.log(`Rendered page ${pageNumber} as background image.`);});}catch(error){console.error(\"Error rendering PDF:\",error);}};renderPDFToCanvas(currentPage);const connectWebSocket=()=>{const webSocketUrl=`ws://127.0.0.1:8080/ws/session/${sessionId}/`;console.log(\"Attempting to connect to WebSocket:\",webSocketUrl);socket.current=new WebSocket(webSocketUrl);socket.current.onopen=()=>{console.log(\"WebSocket connection established.\");};socket.current.onmessage=event=>{const data=JSON.parse(event.data);if(data.type===\"draw\"){console.log(\"Received drawing data:\",data.payload);fabric.util.enlivenObjects([data.payload],objects=>{objects.forEach(obj=>{canvasInstance.add(obj);});});}};socket.current.onclose=()=>{console.warn(\"WebSocket connection closed.\");};socket.current.onerror=error=>{console.error(\"WebSocket error:\",error.message);};};connectWebSocket();return()=>{console.log(\"Cleaning up resources...\");canvasInstance.dispose();if(socket.current){socket.current.close();}};},[currentPage,documentUrl,sessionId]);const goToNextPage=()=>{if(currentPage<totalPages)setCurrentPage(prevPage=>prevPage+1);};const goToPreviousPage=()=>{if(currentPage>1)setCurrentPage(prevPage=>prevPage-1);};return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"canvas\",{ref:canvasRef}),!documentUrl&&/*#__PURE__*/_jsx(\"p\",{style:{color:\"red\"},children:\"No document available to load. Please check the session.\"}),/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:\"10px\"},children:[/*#__PURE__*/_jsx(\"button\",{onClick:goToPreviousPage,disabled:currentPage===1,children:\"Previous Page\"}),/*#__PURE__*/_jsx(\"button\",{onClick:goToNextPage,disabled:currentPage===totalPages||totalPages===0,children:\"Next Page\"}),/*#__PURE__*/_jsxs(\"p\",{children:[\"Page \",currentPage,\" of \",totalPages]})]})]});};export default DocumentCanvas;","map":{"version":3,"names":["React","useState","useRef","useLayoutEffect","pdfjs","useSession","jsx","_jsx","jsxs","_jsxs","fabric","require","GlobalWorkerOptions","workerSrc","DocumentCanvas","sessionId","documentUrl","canvasRef","socket","currentPage","setCurrentPage","totalPages","setTotalPages","current","console","warn","error","canvasInstance","Canvas","width","height","log","renderPDFToCanvas","pageNumber","pdf","getDocument","promise","numPages","page","getPage","viewport","getViewport","scale","pdfCanvas","document","createElement","context","getContext","render","canvasContext","Image","fromURL","toDataURL","oImg","setBackgroundImage","renderAll","bind","connectWebSocket","webSocketUrl","WebSocket","onopen","onmessage","event","data","JSON","parse","type","payload","util","enlivenObjects","objects","forEach","obj","add","onclose","onerror","message","dispose","close","goToNextPage","prevPage","goToPreviousPage","children","ref","style","color","marginTop","onClick","disabled"],"sources":["C:/Users/wesle/OneDrive/Documents/VLCS/myProject/VirtualLCS/frontend/src/DocumentCanvas.jsx"],"sourcesContent":["import React, { useState, useRef, useLayoutEffect } from \"react\";\r\nimport * as pdfjs from \"pdfjs-dist\"; // Import for PDF.js\r\nimport { useSession } from \"./SessionContext\"; // Import for session context\r\n\r\n// Fabric.js (CommonJS import)\r\nconst fabric = require(\"fabric\").fabric;\r\n\r\n// Set the worker source for PDF.js\r\npdfjs.GlobalWorkerOptions.workerSrc = \"/pdf.worker.mjs\"; // Ensure this is correctly set up\r\n\r\nconst DocumentCanvas = () => {\r\n  const { sessionId, documentUrl } = useSession(); // Access sessionId and documentUrl from the session context\r\n  const canvasRef = useRef(null);\r\n  const socket = useRef(null);\r\n  const [currentPage, setCurrentPage] = useState(1);\r\n  const [totalPages, setTotalPages] = useState(0);\r\n\r\n  useLayoutEffect(() => {\r\n    if (!canvasRef.current) {\r\n      console.warn(\"Canvas reference is not ready yet.\");\r\n      return;\r\n    }\r\n\r\n    if (!sessionId) {\r\n      console.error(\"Session ID is missing. WebSocket connection cannot be established.\");\r\n      return;\r\n    }\r\n\r\n    let canvasInstance;\r\n\r\n    // Initialize Fabric.js canvas\r\n    try {\r\n      canvasInstance = new fabric.Canvas(canvasRef.current, {\r\n        width: 800,\r\n        height: 600,\r\n      });\r\n      console.log(\"Fabric.js canvas initialized.\");\r\n    } catch (error) {\r\n      console.error(\"Error initializing Fabric.js canvas:\", error);\r\n      return;\r\n    }\r\n\r\n    const renderPDFToCanvas = async (pageNumber) => {\r\n      if (!documentUrl) {\r\n        console.warn(\"No document URL provided.\");\r\n        return;\r\n      }\r\n\r\n      try {\r\n        const pdf = await pdfjs.getDocument(documentUrl).promise;\r\n        setTotalPages(pdf.numPages);\r\n\r\n        const page = await pdf.getPage(pageNumber);\r\n        const viewport = page.getViewport({ scale: 1.5 });\r\n\r\n        const pdfCanvas = document.createElement(\"canvas\");\r\n        pdfCanvas.width = viewport.width;\r\n        pdfCanvas.height = viewport.height;\r\n\r\n        const context = pdfCanvas.getContext(\"2d\");\r\n        await page.render({ canvasContext: context, viewport }).promise;\r\n\r\n        // Set PDF page as the background for the Fabric.js canvas\r\n        fabric.Image.fromURL(pdfCanvas.toDataURL(), (oImg) => {\r\n          canvasInstance.setBackgroundImage(oImg, canvasInstance.renderAll.bind(canvasInstance));\r\n          console.log(`Rendered page ${pageNumber} as background image.`);\r\n        });\r\n      } catch (error) {\r\n        console.error(\"Error rendering PDF:\", error);\r\n      }\r\n    };\r\n\r\n    renderPDFToCanvas(currentPage);\r\n\r\n    const connectWebSocket = () => {\r\n      const webSocketUrl = `ws://127.0.0.1:8080/ws/session/${sessionId}/`;\r\n      console.log(\"Attempting to connect to WebSocket:\", webSocketUrl);\r\n\r\n      socket.current = new WebSocket(webSocketUrl);\r\n\r\n      socket.current.onopen = () => {\r\n        console.log(\"WebSocket connection established.\");\r\n      };\r\n\r\n      socket.current.onmessage = (event) => {\r\n        const data = JSON.parse(event.data);\r\n        if (data.type === \"draw\") {\r\n          console.log(\"Received drawing data:\", data.payload);\r\n          fabric.util.enlivenObjects([data.payload], (objects) => {\r\n            objects.forEach((obj) => {\r\n              canvasInstance.add(obj);\r\n            });\r\n          });\r\n        }\r\n      };\r\n\r\n      socket.current.onclose = () => {\r\n        console.warn(\"WebSocket connection closed.\");\r\n      };\r\n\r\n      socket.current.onerror = (error) => {\r\n        console.error(\"WebSocket error:\", error.message);\r\n      };\r\n    };\r\n\r\n    connectWebSocket();\r\n\r\n    return () => {\r\n      console.log(\"Cleaning up resources...\");\r\n      canvasInstance.dispose();\r\n      if (socket.current) {\r\n        socket.current.close();\r\n      }\r\n    };\r\n  }, [currentPage, documentUrl, sessionId]);\r\n\r\n  const goToNextPage = () => {\r\n    if (currentPage < totalPages) setCurrentPage((prevPage) => prevPage + 1);\r\n  };\r\n\r\n  const goToPreviousPage = () => {\r\n    if (currentPage > 1) setCurrentPage((prevPage) => prevPage - 1);\r\n  };\r\n\r\n  return (\r\n    <div>\r\n      <canvas ref={canvasRef} />\r\n      {!documentUrl && (\r\n        <p style={{ color: \"red\" }}>\r\n          No document available to load. Please check the session.\r\n        </p>\r\n      )}\r\n      <div style={{ marginTop: \"10px\" }}>\r\n        <button onClick={goToPreviousPage} disabled={currentPage === 1}>\r\n          Previous Page\r\n        </button>\r\n        <button onClick={goToNextPage} disabled={currentPage === totalPages || totalPages === 0}>\r\n          Next Page\r\n        </button>\r\n        <p>\r\n          Page {currentPage} of {totalPages}\r\n        </p>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default DocumentCanvas;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}