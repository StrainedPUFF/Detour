{"ast":null,"code":"import React,{useState,useRef,useEffect}from'react';import{Canvas,Image,util}from'fabric';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const DocumentCanvas=_ref=>{let{documentUrl,sessionId}=_ref;const canvasRef=useRef(null);const[canvas,setCanvas]=useState(null);const socket=useRef(null);// WebSocket connection\nconst reconnectInterval=5000;// Reconnection interval (in milliseconds)\nconst maxReconnectAttempts=5;// Limit retry attempts\nlet reconnectAttempts=0;useEffect(()=>{console.log('Initializing canvas...');// Create a Fabric.js canvas instance\nconst canvasInstance=new Canvas(canvasRef.current,{width:800,height:600});setCanvas(canvasInstance);// Load the background image\nif(documentUrl){Image.fromURL(documentUrl,img=>{canvasInstance.setBackgroundImage(img,canvasInstance.renderAll.bind(canvasInstance),{crossOrigin:'anonymous'// Prevent cross-origin issues\n});console.log('Document URL loaded:',documentUrl);},{crossOrigin:'anonymous'});}else{console.warn('No document URL provided.');}// WebSocket connection logic\nconst connectWebSocket=()=>{if(!sessionId){console.error('Session ID is undefined. Unable to initialize WebSocket.');return;}socket.current=new WebSocket(`ws://127.0.0.1:8080/ws/session/${sessionId}/`);socket.current.onopen=()=>{console.log('WebSocket connection established.');reconnectAttempts=0;// Reset reconnect attempts\n};socket.current.onmessage=event=>{const data=JSON.parse(event.data);if(data.type==='draw'){console.log('Received draw data:',data.payload);util.enlivenObjects([data.payload],objects=>{objects.forEach(obj=>{if(canvasInstance){canvasInstance.add(obj);}});});}};socket.current.onclose=()=>{console.warn('WebSocket disconnected.');if(reconnectAttempts<maxReconnectAttempts){reconnectAttempts+=1;console.warn(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);setTimeout(connectWebSocket,reconnectInterval);}else{console.error('Max reconnect attempts reached. Unable to reconnect WebSocket.');}};socket.current.onerror=error=>{console.error('WebSocket error:',error.message);};};// Initialize WebSocket connection\nconnectWebSocket();// Enable drawing mode and handle annotations\ncanvasInstance.isDrawingMode=true;canvasInstance.on('path:created',e=>{const path=e.path;emitObjectData(path);});// Emit data when an object is added to the canvas\nconst emitObjectData=object=>{try{if(socket.current){socket.current.send(JSON.stringify({type:'draw',payload:object.toJSON()}));console.log('Object emitted:',object);}}catch(error){console.error('Error emitting object data:',error.message);}};// Cleanup on component unmount\nreturn()=>{console.log('Cleaning up resources...');canvasInstance.dispose();if(socket.current){socket.current.close();}};},[documentUrl,sessionId]);return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"canvas\",{ref:canvasRef}),!documentUrl&&/*#__PURE__*/_jsx(\"p\",{style:{color:'red'},children:\"No document available to load.\"})]});};export default DocumentCanvas;","map":{"version":3,"names":["React","useState","useRef","useEffect","Canvas","Image","util","jsx","_jsx","jsxs","_jsxs","DocumentCanvas","_ref","documentUrl","sessionId","canvasRef","canvas","setCanvas","socket","reconnectInterval","maxReconnectAttempts","reconnectAttempts","console","log","canvasInstance","current","width","height","fromURL","img","setBackgroundImage","renderAll","bind","crossOrigin","warn","connectWebSocket","error","WebSocket","onopen","onmessage","event","data","JSON","parse","type","payload","enlivenObjects","objects","forEach","obj","add","onclose","setTimeout","onerror","message","isDrawingMode","on","e","path","emitObjectData","object","send","stringify","toJSON","dispose","close","children","ref","style","color"],"sources":["C:/Users/wesle/OneDrive/Documents/VLCS/myProject/VirtualLCS/frontend/src/DocumentCanvas.jsx"],"sourcesContent":["import React, { useState, useRef, useEffect } from 'react';\r\nimport { Canvas, Image, util } from 'fabric';\r\n\r\nconst DocumentCanvas = ({ documentUrl, sessionId }) => {\r\n  const canvasRef = useRef(null);\r\n  const [canvas, setCanvas] = useState(null);\r\n  const socket = useRef(null); // WebSocket connection\r\n  const reconnectInterval = 5000; // Reconnection interval (in milliseconds)\r\n  const maxReconnectAttempts = 5; // Limit retry attempts\r\n  let reconnectAttempts = 0;\r\n\r\n  useEffect(() => {\r\n    console.log('Initializing canvas...');\r\n    // Create a Fabric.js canvas instance\r\n    const canvasInstance = new Canvas(canvasRef.current, {\r\n      width: 800,\r\n      height: 600,\r\n    });\r\n    setCanvas(canvasInstance);\r\n\r\n    // Load the background image\r\n    if (documentUrl) {\r\n      Image.fromURL(\r\n        documentUrl,\r\n        (img) => {\r\n          canvasInstance.setBackgroundImage(\r\n            img,\r\n            canvasInstance.renderAll.bind(canvasInstance),\r\n            {\r\n              crossOrigin: 'anonymous', // Prevent cross-origin issues\r\n            }\r\n          );\r\n          console.log('Document URL loaded:', documentUrl);\r\n        },\r\n        { crossOrigin: 'anonymous' }\r\n      );\r\n    } else {\r\n      console.warn('No document URL provided.');\r\n    }\r\n\r\n    // WebSocket connection logic\r\n    const connectWebSocket = () => {\r\n      if (!sessionId) {\r\n        console.error('Session ID is undefined. Unable to initialize WebSocket.');\r\n        return;\r\n      }\r\n\r\n      socket.current = new WebSocket(`ws://127.0.0.1:8080/ws/session/${sessionId}/`);\r\n\r\n      socket.current.onopen = () => {\r\n        console.log('WebSocket connection established.');\r\n        reconnectAttempts = 0; // Reset reconnect attempts\r\n      };\r\n\r\n      socket.current.onmessage = (event) => {\r\n        const data = JSON.parse(event.data);\r\n        if (data.type === 'draw') {\r\n          console.log('Received draw data:', data.payload);\r\n          util.enlivenObjects([data.payload], (objects) => {\r\n            objects.forEach((obj) => {\r\n              if (canvasInstance) {\r\n                canvasInstance.add(obj);\r\n              }\r\n            });\r\n          });\r\n        }\r\n      };\r\n\r\n      socket.current.onclose = () => {\r\n        console.warn('WebSocket disconnected.');\r\n        if (reconnectAttempts < maxReconnectAttempts) {\r\n          reconnectAttempts += 1;\r\n          console.warn(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);\r\n          setTimeout(connectWebSocket, reconnectInterval);\r\n        } else {\r\n          console.error('Max reconnect attempts reached. Unable to reconnect WebSocket.');\r\n        }\r\n      };\r\n\r\n      socket.current.onerror = (error) => {\r\n        console.error('WebSocket error:', error.message);\r\n      };\r\n    };\r\n\r\n    // Initialize WebSocket connection\r\n    connectWebSocket();\r\n\r\n    // Enable drawing mode and handle annotations\r\n    canvasInstance.isDrawingMode = true;\r\n    canvasInstance.on('path:created', (e) => {\r\n      const path = e.path;\r\n      emitObjectData(path);\r\n    });\r\n\r\n    // Emit data when an object is added to the canvas\r\n    const emitObjectData = (object) => {\r\n      try {\r\n        if (socket.current) {\r\n          socket.current.send(\r\n            JSON.stringify({\r\n              type: 'draw',\r\n              payload: object.toJSON(),\r\n            })\r\n          );\r\n          console.log('Object emitted:', object);\r\n        }\r\n      } catch (error) {\r\n        console.error('Error emitting object data:', error.message);\r\n      }\r\n    };\r\n\r\n    // Cleanup on component unmount\r\n    return () => {\r\n      console.log('Cleaning up resources...');\r\n      canvasInstance.dispose();\r\n      if (socket.current) {\r\n        socket.current.close();\r\n      }\r\n    };\r\n  }, [documentUrl, sessionId]);\r\n\r\n  return (\r\n    <div>\r\n      <canvas ref={canvasRef} />\r\n      {!documentUrl && <p style={{ color: 'red' }}>No document available to load.</p>}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default DocumentCanvas;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}