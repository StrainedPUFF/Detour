{"ast":null,"code":"import React,{useRef,useEffect,useCallback,useState}from'react';import{useSession}from'./SessionContext';// Import the session context hook\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const AudioChat=()=>{const{sessionId}=useSession();// Access the sessionId from the context\nconst audioRef=useRef(null);const socket=useRef(null);const peerConnections=useRef({});// Peer connections stored here\nconst[isMuted,setIsMuted]=useState(false);// Mute/unmute state\nconst config={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};const reconnectInterval=5000;// Reconnection interval\nconst maxReconnectAttempts=5;const reconnectAttemptsRef=useRef(0);// Use ref to preserve mutable state across renders\nconst handleOffer=useCallback(offer=>{const peerConnection=new RTCPeerConnection(config);peerConnections.current[offer.sender]=peerConnection;peerConnection.setRemoteDescription(new RTCSessionDescription(offer));navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{stream.getTracks().forEach(track=>peerConnection.addTrack(track,stream));}).catch(error=>console.error('Error accessing user media:',error.message));peerConnection.createAnswer().then(answer=>{peerConnection.setLocalDescription(answer);socket.current.send(JSON.stringify({type:'answer',sdp:answer,sender:'client'}));});peerConnection.ontrack=event=>{audioRef.current.srcObject=event.streams[0];};peerConnection.onicecandidate=event=>{if(event.candidate){socket.current.send(JSON.stringify({type:'ice-candidate',candidate:event.candidate,sender:'client'}));}};},[config]);const handleAnswer=useCallback(answer=>{const peerConnection=peerConnections.current[answer.sender];if(peerConnection){peerConnection.setRemoteDescription(new RTCSessionDescription(answer));}},[]);const handleNewICECandidateMsg=useCallback(msg=>{const candidate=new RTCIceCandidate(msg.candidate);const peerConnection=peerConnections.current[msg.sender];if(peerConnection){peerConnection.addIceCandidate(candidate);}},[]);const connectWebSocket=useCallback(()=>{if(!sessionId){console.error('Session ID is undefined. Unable to initialize WebSocket.');return;}socket.current=new WebSocket(`ws://127.0.0.1:8080/ws/session/${sessionId}/`);socket.current.onopen=()=>{console.log('WebSocket connection established');reconnectAttemptsRef.current=0;// Reset reconnect attempts\nsocket.current.send(JSON.stringify({type:'join',sessionId}));};socket.current.onmessage=event=>{const data=JSON.parse(event.data);if(data.type==='offer')handleOffer(data);if(data.type==='answer')handleAnswer(data);if(data.type==='ice-candidate')handleNewICECandidateMsg(data);};socket.current.onclose=()=>{console.warn('WebSocket disconnected.');if(reconnectAttemptsRef.current<maxReconnectAttempts){reconnectAttemptsRef.current+=1;console.warn(`Attempting to reconnect (${reconnectAttemptsRef.current}/${maxReconnectAttempts})...`);setTimeout(connectWebSocket,reconnectInterval);}else{console.error('Max reconnect attempts reached. Unable to reconnect WebSocket.');}};socket.current.onerror=error=>{console.error('WebSocket error:',error.message);};},[sessionId,handleOffer,handleAnswer,handleNewICECandidateMsg]);useEffect(()=>{connectWebSocket();return()=>{var _socket$current;(_socket$current=socket.current)===null||_socket$current===void 0?void 0:_socket$current.close();Object.values(peerConnections.current).forEach(peerConnection=>peerConnection.close());};},[connectWebSocket]);const toggleMute=()=>{var _audioRef$current$src;const audioTracks=(_audioRef$current$src=audioRef.current.srcObject)===null||_audioRef$current$src===void 0?void 0:_audioRef$current$src.getAudioTracks();if(audioTracks){audioTracks.forEach(track=>track.enabled=!isMuted);setIsMuted(!isMuted);}};return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"audio\",{ref:audioRef,autoPlay:true}),/*#__PURE__*/_jsx(\"button\",{onClick:toggleMute,children:isMuted?'Unmute':'Mute'})]});};export default AudioChat;","map":{"version":3,"names":["React","useRef","useEffect","useCallback","useState","useSession","jsx","_jsx","jsxs","_jsxs","AudioChat","sessionId","audioRef","socket","peerConnections","isMuted","setIsMuted","config","iceServers","urls","reconnectInterval","maxReconnectAttempts","reconnectAttemptsRef","handleOffer","offer","peerConnection","RTCPeerConnection","current","sender","setRemoteDescription","RTCSessionDescription","navigator","mediaDevices","getUserMedia","audio","then","stream","getTracks","forEach","track","addTrack","catch","error","console","message","createAnswer","answer","setLocalDescription","send","JSON","stringify","type","sdp","ontrack","event","srcObject","streams","onicecandidate","candidate","handleAnswer","handleNewICECandidateMsg","msg","RTCIceCandidate","addIceCandidate","connectWebSocket","WebSocket","onopen","log","onmessage","data","parse","onclose","warn","setTimeout","onerror","_socket$current","close","Object","values","toggleMute","_audioRef$current$src","audioTracks","getAudioTracks","enabled","children","ref","autoPlay","onClick"],"sources":["C:/Users/wesle/OneDrive/Documents/VLCS/myProject/VirtualLCS/frontend/src/AudioChat.jsx"],"sourcesContent":["import React, { useRef, useEffect, useCallback, useState } from 'react';\r\nimport { useSession } from './SessionContext'; // Import the session context hook\r\n\r\nconst AudioChat = () => {\r\n  const { sessionId } = useSession(); // Access the sessionId from the context\r\n  const audioRef = useRef(null);\r\n  const socket = useRef(null);\r\n  const peerConnections = useRef({}); // Peer connections stored here\r\n  const [isMuted, setIsMuted] = useState(false); // Mute/unmute state\r\n  const config = {\r\n    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],\r\n  };\r\n  const reconnectInterval = 5000; // Reconnection interval\r\n  const maxReconnectAttempts = 5;\r\n  const reconnectAttemptsRef = useRef(0); // Use ref to preserve mutable state across renders\r\n\r\n  const handleOffer = useCallback((offer) => {\r\n    const peerConnection = new RTCPeerConnection(config);\r\n    peerConnections.current[offer.sender] = peerConnection;\r\n\r\n    peerConnection.setRemoteDescription(new RTCSessionDescription(offer));\r\n    navigator.mediaDevices.getUserMedia({ audio: true })\r\n      .then((stream) => {\r\n        stream.getTracks().forEach((track) => peerConnection.addTrack(track, stream));\r\n      })\r\n      .catch((error) => console.error('Error accessing user media:', error.message));\r\n    \r\n    peerConnection.createAnswer()\r\n      .then((answer) => {\r\n        peerConnection.setLocalDescription(answer);\r\n        socket.current.send(\r\n          JSON.stringify({\r\n            type: 'answer',\r\n            sdp: answer,\r\n            sender: 'client',\r\n          })\r\n        );\r\n      });\r\n    \r\n    peerConnection.ontrack = (event) => {\r\n      audioRef.current.srcObject = event.streams[0];\r\n    };\r\n    peerConnection.onicecandidate = (event) => {\r\n      if (event.candidate) {\r\n        socket.current.send(\r\n          JSON.stringify({\r\n            type: 'ice-candidate',\r\n            candidate: event.candidate,\r\n            sender: 'client',\r\n          })\r\n        );\r\n      }\r\n    };\r\n  }, [config]);\r\n\r\n  const handleAnswer = useCallback((answer) => {\r\n    const peerConnection = peerConnections.current[answer.sender];\r\n    if (peerConnection) {\r\n      peerConnection.setRemoteDescription(new RTCSessionDescription(answer));\r\n    }\r\n  }, []);\r\n\r\n  const handleNewICECandidateMsg = useCallback((msg) => {\r\n    const candidate = new RTCIceCandidate(msg.candidate);\r\n    const peerConnection = peerConnections.current[msg.sender];\r\n    if (peerConnection) {\r\n      peerConnection.addIceCandidate(candidate);\r\n    }\r\n  }, []);\r\n\r\n  const connectWebSocket = useCallback(() => {\r\n    if (!sessionId) {\r\n      console.error('Session ID is undefined. Unable to initialize WebSocket.');\r\n      return;\r\n    }\r\n\r\n    socket.current = new WebSocket(`ws://127.0.0.1:8080/ws/session/${sessionId}/`);\r\n\r\n    socket.current.onopen = () => {\r\n      console.log('WebSocket connection established');\r\n      reconnectAttemptsRef.current = 0; // Reset reconnect attempts\r\n      socket.current.send(JSON.stringify({ type: 'join', sessionId }));\r\n    };\r\n\r\n    socket.current.onmessage = (event) => {\r\n      const data = JSON.parse(event.data);\r\n      if (data.type === 'offer') handleOffer(data);\r\n      if (data.type === 'answer') handleAnswer(data);\r\n      if (data.type === 'ice-candidate') handleNewICECandidateMsg(data);\r\n    };\r\n\r\n    socket.current.onclose = () => {\r\n      console.warn('WebSocket disconnected.');\r\n      if (reconnectAttemptsRef.current < maxReconnectAttempts) {\r\n        reconnectAttemptsRef.current += 1;\r\n        console.warn(`Attempting to reconnect (${reconnectAttemptsRef.current}/${maxReconnectAttempts})...`);\r\n        setTimeout(connectWebSocket, reconnectInterval);\r\n      } else {\r\n        console.error('Max reconnect attempts reached. Unable to reconnect WebSocket.');\r\n      }\r\n    };\r\n\r\n    socket.current.onerror = (error) => {\r\n      console.error('WebSocket error:', error.message);\r\n    };\r\n  }, [sessionId, handleOffer, handleAnswer, handleNewICECandidateMsg]);\r\n\r\n  useEffect(() => {\r\n    connectWebSocket();\r\n\r\n    return () => {\r\n      socket.current?.close();\r\n      Object.values(peerConnections.current).forEach((peerConnection) => peerConnection.close());\r\n    };\r\n  }, [connectWebSocket]);\r\n\r\n  const toggleMute = () => {\r\n    const audioTracks = audioRef.current.srcObject?.getAudioTracks();\r\n    if (audioTracks) {\r\n      audioTracks.forEach((track) => (track.enabled = !isMuted));\r\n      setIsMuted(!isMuted);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div>\r\n      <audio ref={audioRef} autoPlay />\r\n      <button onClick={toggleMute}>{isMuted ? 'Unmute' : 'Mute'}</button>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default AudioChat;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}